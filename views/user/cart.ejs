<%- include ('../partials/header') -%>

<main class="main">
    <div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
        <div class="container">
            <h1 class="page-title">Shopping Cart<span>Shop</span></h1>
        </div><!-- End .container -->
    </div><!-- End .page-header -->
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="#">Shop</a></li>
                <li class="breadcrumb-item active" aria-current="page">Shopping Cart</li>
            </ol>
        </div><!-- End .container -->
    </nav><!-- End .breadcrumb-nav -->

    <div class="page-content">
        <div class="cart">
            <div class="container">
                <% if(cart && cart.products.length) {%>


                    
                <div class="row" >
                    <div class="col-lg-9">
                        <table class="table table-cart table-mobile" id="myTable">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                            </thead>

                            <tbody>

                               <% cart.products.forEach(function(product) { %>
                                <tr>
                                    <td class="product-col">
                                        <div class="product">
                                            <figure class="product-media">
                                                <a href="#">
                                                    <img src=upload/<%=product.productid.productimage[2]%> alt="Product image">
                                                </a>
                                            </figure>
                                
                                            <h3 class="product-title">
                                                <a href="#"><%= product.productid.productname %></a>
                                            </h3><!-- End .product-title -->
                                        </div><!-- End .product -->
                                        <input type="hidden" id="cartid" value="<%=product._id%>">
                                    </td>
                                    <td class="price-col price">₹ <%= product.productid.price %>.00</td>
                                    <td class="quantity-col">
                                        <!-- <div class="cart-product-quantity"> 
                                            <input type="number" class="form-control" value="1" min="1" max="10" step="1" data-decimals="0" required> 
                                        </div>/ -->
                                         <!-- End .cart-product-quantity -->
                                         <button class="cart-qty-minus" style="border: none;" data-proid="<%=product.productid._id%>" type="button" >-</button>

                                         <input type="text"  name="qty" min="0" class="qty text-center" min="0"  value="<%=product.Cartquantity%>" style="width: 30px;" readonly >

                                         <button class="cart-qty-plus" style="border: none;" data-proid="<%=product.productid._id%>"  type="button" >+</button>
                                    </td>
                                    <td class="amount total-col "></td>
                                    <td class="remove-col"><button class="btn-remove" ><a href="/deleteCartItem?id=<%=product._id%>"><i class="icon-close"></i></a></button></td>
                                </tr>
                                <% }); %>
                            </tbody>
                        </table><!-- End .table table-wishlist -->

                        <div class="cart-bottom">
                            <div class="cart-discount">
                                <form action="#">
                                    <!-- <div class="input-group"> -->
                                        <!-- <input type="text" class="form-control" required placeholder="coupon code"> -->
                                        <!-- <div class="input-group-append"> -->
                                            <!-- <button class="btn btn-outline-primary-2" type="submit"><i class="icon-long-arrow-right"></i></button> -->
                                      <!--  </div> .End .input-group-append -->
                                  <!--  </div> End .input-group -->
                               </form>
                            </div><!-- End .cart-discount -->

                            <a href="/cart" class="btn btn-outline-dark-2"><span>UPDATE CART</span><i class="icon-refresh"></i></a>
                        </div><!-- End .cart-bottom -->
                    </div><!-- End .col-lg-9 -->
                    <aside class="col-lg-3">
                        <div class="summary summary-cart">
                            <h3 class="summary-title">Cart Total</h3><!-- End .summary-title -->

                            <table class="table table-summary">
                                <tbody>
                                    <tr class="summary-subtotal">
                                        <td>Subtotal:</td>
                                        <td class="total"></td>
                                    </tr><!-- End .summary-subtotal -->
                                    <tr class="summary-shipping">
                                        <td>Shipping:</td>
                                        <td>&nbsp;</td>
                                    </tr>

                                    <tr class="summary-shipping-row">
                                        <td>
                                            <div class="custom-control custom-radio">
                                                <input type="radio" id="free-shipping" name="shipping" class="custom-control-input" checked>
                                                <label class="custom-control-label" for="free-shipping">Free Shipping</label>
                                            </div><!-- End .custom-control -->
                                        </td>
                                        <td>$0.00</td>
                                    </tr><!-- End .summary-shipping-row -->

                                    <tr class="summary-shipping-estimate">
                                        <td>Estimate for Your Country<br> <a href="/userdash#tab-address">Change address</a></td>
                                        <td>&nbsp;</td>
                                    </tr><!-- End .summary-shipping-estimate -->

                                    <tr class="summary-total">
                                        <td>Total:</td>
                                        <td class="total"></td>
                                    </tr><!-- End .summary-total -->
                                </tbody>
                            </table><!-- End .table table-summary -->

                            <a href="/checkout" class="btn btn-outline-primary-2 btn-order btn-block">PROCEED TO CHECKOUT</a>
                        </div><!-- End .summary -->

                        <a href="/" class="btn btn-outline-dark-2 btn-block mb-3"><span>CONTINUE SHOPPING</span><i class="icon-refresh"></i></a>
                    </aside><!-- End .col-lg-3 -->
                </div><!-- End .row -->
                <% }else{ %>
                <div class=" text-center">
                        <p> <strong>Hi <%=userdata.name%>,</strong> <br> Your Cart is Empty</p> <br>
                        <a href="/" class="btn btn-outline-dark-2 mb-3"><span>CONTINUE SHOPPING</span><i class="icon-refresh"></i></a>
                </div><!-- End .page-header -->
                    <% } %>
            </div><!-- End .container -->
        </div><!-- End .cart -->
    </div><!-- End .page-content -->
</main><!-- End .main -->
<%- include ('../partials/footer') -%>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.js"></script>


<script>
$(document).ready(function(){
  update_amounts();
  
  // Handle quantity changes
  $('.qty,.price').on('keyup keypress blur change', function(e){
    update_amounts();
  });
  
  // Handle increment/decrement buttons
  $('.cart-qty-plus').on('click', function(){
	console.log("clicked");
	var proID = $(this).data('proid')
     var input = $(this).siblings('.qty');
	var qty = $(this).siblings('.qty').val();
    console.log(proID);
    
    console.log(qty);
	var data = {quantity:qty,proID:proID}
  	
	//with incrementing the quatity number ajax call
	$.ajax({
		url:'/incrementproduct',
		method:"post",
		data:data,
		success: function(response){
		console.log(response.message);
		 if(response.message == "0"){
		// if response is zero it means product Quantity is unavailable
			console.log("failed");
			Swal.fire({
                            title: "Error",
                            text: "Item is Out of Stoke",
                            icon: "error",
                            confirmButtonText: "OK"
                        }); 
		 }else{
			
          var val = parseInt(input.val());
          input.val(val + 1);
          update_amounts();
		 }
		}
	})

  });

 		 $(".cart-qty-minus").on("click", function () {
                console.log("clicked");
                var proID = $(this).data("proid");
                var input = $(this).siblings(".qty");
				var qty = $(this).siblings('.qty').val();
                var data = {quantity:qty,proID:proID}
				
                $.ajax({
                url: '/decrement',                    
                method: "post",
				data:data,
                success: function (response) {
                    if (response.message == "0"){
                    Swal.fire({
                        title: "Error",
                        html: "Product quantity cannot be less than 1,<br> You can delete product.",
                        icon: "error",
                        confirmButtonText: "OK",
                    });
                    } else {
                    var val = parseInt(input.val());
                    input.val(val - 1);
                    update_amounts();
                    }
                },
                });

				});

			});

function update_amounts(){
  var sum = 0.0;
  $('#myTable > tbody > tr').each(function(){
    var qty = $(this).find('.qty').val();
    var price = $(this).find('.price').text().replace(/[^\d\.]/g, '');
    var amount = qty * price;
    sum += amount;
    $(this).find('.amount').text('₹' + amount.toFixed(2));
  });
  $('.total').text('₹' + sum.toFixed(2));
}
   
  </script>
          